<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PROJECT: VOID-KEEPER v1.3</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@900&display=swap');

        :root {
            --bg: #020202;
            --term: #ffaa00; /* Amber Terminal */
            --term-dim: rgba(255, 170, 0, 0.3);
            --fuel: #ff3333; /* Red */
            --scrap: #00aaff; /* Blue */
            --focus: #00ffff; /* Cyan for Focus Mode */
        }

        body {
            margin: 0; overflow: hidden; background: var(--bg); color: var(--term);
            font-family: 'Share Tech Mono', monospace;
            user-select: none;
            cursor: crosshair;
            touch-action: none;
        }

        canvas { position: absolute; top: 0; left: 0; z-index: 1; }
        
        /* UI LAYER */
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
            padding: 20px; box-sizing: border-box;
            background: radial-gradient(circle, transparent 50%, #000 120%); /* Vignette */
        }

        /* MAIN MENU */
        #main-menu {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #050505; z-index: 2000; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            background-image: radial-gradient(circle, #111 0%, #000 80%);
            pointer-events: auto;
        }
        .menu-title { font-family: 'Orbitron'; font-size: 4rem; margin-bottom: 40px; text-shadow: 0 0 20px var(--term); letter-spacing: 5px; text-align: center; }
        .menu-btn {
            width: 300px; padding: 15px; margin: 10px; background: transparent;
            border: 2px solid var(--term-dim); color: var(--term);
            font-family: 'Orbitron'; font-size: 1.1rem; cursor: pointer;
            transition: 0.2s; text-align: center; pointer-events: auto;
        }
        .menu-btn:hover { background: var(--term); color: #000; box-shadow: 0 0 20px var(--term); transform: scale(1.05); }
        .menu-btn.disabled { opacity: 0.5; cursor: not-allowed; border-color: #333; color: #555; }
        .menu-btn.disabled:hover { background: transparent; color: #555; box-shadow: none; transform: none; }

        /* SETTINGS MODAL */
        #settings-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 450px; background: #080808; border: 2px solid var(--scrap);
            z-index: 3000; display: none; flex-direction: column; padding: 25px;
            box-shadow: 0 0 50px rgba(0, 170, 255, 0.2); pointer-events: auto;
        }
        .set-header { font-family: 'Orbitron'; color: var(--scrap); border-bottom: 1px solid var(--scrap); padding-bottom: 10px; margin-bottom: 20px; font-size: 1.5rem; }
        .set-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .set-label { color: #ccc; font-size: 1rem; }
        
        input[type=range] { width: 50%; accent-color: var(--scrap); cursor: pointer; }
        select { background: #000; color: var(--scrap); border: 1px solid var(--scrap); padding: 5px; font-family: 'Share Tech Mono'; cursor: pointer; }

        /* MANUAL MODAL */
        #manual-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 800px; height: 500px; background: #050505; border: 2px solid var(--term);
            z-index: 2500; display: none; flex-direction: row; pointer-events: auto;
            box-shadow: 0 0 50px rgba(255, 170, 0, 0.2);
        }
        .man-nav { width: 200px; border-right: 1px solid var(--term-dim); display: flex; flex-direction: column; background: #0a0a0a; }
        .man-tab {
            padding: 20px; color: #888; cursor: pointer; border-bottom: 1px solid #222;
            transition: 0.2s; font-family: 'Orbitron'; font-size: 0.9rem;
        }
        .man-tab:hover { color: var(--term); background: rgba(255, 170, 0, 0.1); }
        .man-tab.active { color: #000; background: var(--term); font-weight: bold; }
        
        .man-content { flex: 1; padding: 30px; overflow-y: auto; color: #ccc; font-size: 1rem; line-height: 1.6; }
        .man-page { display: none; animation: fadeIn 0.3s; }
        .man-page.active { display: block; }
        .lore-entry { margin-bottom: 20px; border-left: 3px solid #333; padding-left: 15px; background: rgba(255,255,255,0.02); padding: 10px; }
        .lore-locked { color: #444; font-style: italic; }
        
        .close-btn { 
            position: absolute; top: 10px; right: 10px; width: 30px; height: 30px;
            border: 1px solid var(--term); background: #000; color: var(--term); 
            cursor: pointer; font-weight: bold; font-family: 'Orbitron';
        }
        .close-btn:hover { background: var(--term); color: #000; }

        /* HUD ELEMENTS */
        .hud-panel { pointer-events: auto; text-shadow: 0 0 5px var(--term); }
        .header-bar {
            display: flex; justify-content: space-between; align-items: flex-start;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
            padding-bottom: 15px; border-bottom: 1px solid var(--term-dim);
        }
        .cog-btn {
            font-size: 2rem; background: none; border: none; color: #666; cursor: pointer; pointer-events: auto; transition: 0.3s;
        }
        .cog-btn:hover { color: var(--term); transform: rotate(90deg); }

        /* RESOURCES */
        .resources { display: flex; gap: 30px; font-size: 1.2rem; margin-top: 5px; }
        .c-fuel { color: var(--fuel); text-shadow: 0 0 10px var(--fuel); }
        .c-scrap { color: var(--scrap); text-shadow: 0 0 10px var(--scrap); }

        /* LOG */
        .log-container {
            position: absolute; top: 120px; left: 20px; width: 350px; height: 200px;
            overflow: hidden; opacity: 0.8; font-size: 0.85rem; line-height: 1.4;
            mask-image: linear-gradient(to bottom, transparent, black 10%, black 90%, transparent);
            -webkit-mask-image: linear-gradient(to bottom, transparent, black 10%, black 90%, transparent);
            pointer-events: none;
        }
        .log-entry { margin-bottom: 6px; border-left: 2px solid var(--term-dim); padding-left: 8px; }
        .log-time { color: #666; margin-right: 8px; font-size: 0.7rem; }

        /* FUEL BAR */
        .fuel-container {
            position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%);
            width: 500px; text-align: center;
        }
        .fuel-bar-bg { width: 100%; height: 8px; background: #220000; border: 1px solid #550000; box-shadow: 0 0 20px #220000; }
        .fuel-fill { width: 100%; height: 100%; background: var(--fuel); box-shadow: 0 0 15px var(--fuel); transition: width 0.1s linear; }

        /* UPGRADES */
        .upgrades {
            position: absolute; bottom: 20px; right: 20px;
            display: flex; flex-direction: column; gap: 10px; align-items: flex-end;
        }
        .upgrade-btn {
            background: rgba(0,0,0,0.9); border: 1px solid var(--term-dim); color: var(--term);
            padding: 12px 15px; cursor: pointer; font-family: 'Share Tech Mono';
            text-align: right; width: 240px; pointer-events: auto; position: relative;
            transition: 0.2s;
        }
        .upgrade-btn:hover:not(:disabled) { border-color: var(--term); background: rgba(255, 170, 0, 0.15); transform: translateX(-5px); }
        .upgrade-btn:disabled { opacity: 0.4; border-color: #333; cursor: not-allowed; }
        .u-lvl { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 1.8rem; opacity: 0.15; font-weight: bold; font-family: 'Orbitron'; }

        /* MANUAL BUTTON */
        #manual-open-btn {
            position: absolute; bottom: 20px; left: 20px; width: 60px; height: 60px;
            background: #000; border: 2px solid var(--term); color: var(--term);
            font-size: 2rem; cursor: pointer; pointer-events: auto;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 0 15px rgba(255, 170, 0, 0.2); transition: 0.2s;
        }
        #manual-open-btn:hover { background: var(--term); color: #000; }

        /* DEATH SCREEN */
        #death-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 0, 0, 0.98); z-index: 4000; display: none;
            flex-direction: column; justify-content: center; align-items: center;
            color: var(--fuel); text-align: center; pointer-events: auto;
        }
        .death-title { font-family: 'Orbitron'; font-size: 5rem; text-shadow: 0 0 30px red; animation: glitch 0.3s infinite; }

        /* TARGET RETICLE */
        #reticle {
            position: absolute; width: 60px; height: 60px; border: 2px solid var(--focus);
            border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none;
            display: none; box-shadow: 0 0 20px var(--focus);
            animation: spin 1s linear infinite; z-index: 100;
        }
        .reticle-dot { width: 4px; height: 4px; background: #fff; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border-radius: 50%; }

        @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
        @keyframes glitch { 0% { transform: translate(1px,1px); } 25% { transform: translate(-1px,-1px); } 50% { transform: translate(2px,0); } 75% { transform: translate(-2px,0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    </style>
</head>
<body>

    <div id="main-menu">
        <div class="menu-title">VOID-KEEPER</div>
        <button class="menu-btn" onclick="Game.boot()">PLAY</button>
        <button class="menu-btn disabled" title="Coming Soon">MULTIPLAYER (OFFLINE)</button>
        <button class="menu-btn" onclick="UI.openSettings()">SETTINGS</button>
        <button class="menu-btn" onclick="window.close()">EXIT</button>
        <div style="margin-top:20px; font-size:0.8rem; color:#666;">v1.3 STABLE // SYSTEM READY</div>
    </div>

    <div id="settings-modal">
        <button class="close-btn" onclick="UI.closeSettings()">X</button>
        <div class="set-header">SYSTEM CONFIG</div>
        
        <div class="set-row">
            <span class="set-label">MASTER VOLUME</span>
            <input type="range" id="vol-master" min="0" max="100" value="50" oninput="AudioSys.setMaster(this.value)">
        </div>
        <div class="set-row">
            <span class="set-label">SFX VOLUME</span>
            <input type="range" id="vol-sfx" min="0" max="100" value="70" oninput="AudioSys.setSFX(this.value)">
        </div>
        
        <div class="set-row">
            <span class="set-label">GRAPHICS QUALITY</span>
            <select id="set-quality" onchange="Game.setQuality(this.value)">
                <option value="high">HIGH (Full Fog)</option>
                <option value="low">LOW (Simple Fog)</option>
            </select>
        </div>
        <div class="set-row">
            <span class="set-label">RESOLUTION SCALE</span>
            <select id="set-res" onchange="Game.setResolution(this.value)">
                <option value="1">NATIVE (1.0x)</option>
                <option value="0.5">PERFORMANCE (0.5x)</option>
            </select>
        </div>
        <div class="set-row">
            <span class="set-label">FPS CAP</span>
            <select id="set-fps" onchange="Game.setFPS(this.value)">
                <option value="60">60 FPS</option>
                <option value="30">30 FPS</option>
                <option value="0">UNCAPPED</option>
            </select>
        </div>
        
        <button class="menu-btn" style="width:100%; margin:20px 0 0 0; border-color:var(--fuel); color:var(--fuel);" onclick="Game.hardWipe()">FACTORY RESET SAVE</button>
    </div>

    <div id="manual-modal">
        <button class="close-btn" onclick="document.getElementById('manual-modal').style.display='none'">X</button>
        <div class="man-nav">
            <div class="man-tab active" onclick="UI.switchTab(0, this)">DIRECTIVES</div>
            <div class="man-tab" onclick="UI.switchTab(1, this)">CATALOGUE</div>
            <div class="man-tab" onclick="UI.switchTab(2, this)">ENTITIES</div>
        </div>
        <div class="man-content">
            <div id="page-0" class="man-page active">
                <h2 style="color:var(--term); border-bottom:1px solid #333; padding-bottom:10px;">OPERATIONAL DIRECTIVES</h2>
                <p>1. <b>MAINTAIN LIGHT:</b> The Core burns <span style="color:var(--fuel)">CARBON</span>. If Carbon reaches 0, the Vantablack consumes you. Containment fails.</p>
                <p>2. <b>SCAVENGE:</b> The darkness hides resources. The Light Beam burns away fog. Look for faint <span style="color:#fff">White Glints</span> in the distance.</p>
                <p>3. <b>FOCUS BEAM:</b> Hold <b>LEFT MOUSE</b> to stop rotation and narrow the beam. This triples burn intensity, allowing you to reach distant objects.</p>
                <p>4. <b>HARVEST:</b> Once debris is revealed (Red or Blue brackets appear), <b>CLICK IT</b> to collect.</p>
            </div>
            <div id="page-1" class="man-page">
                <h2 style="color:var(--term); border-bottom:1px solid #333; padding-bottom:10px;">DATA LOGS</h2>
                <div id="lore-list"></div>
            </div>
            <div id="page-2" class="man-page">
                <h2 style="color:var(--term); border-bottom:1px solid #333; padding-bottom:10px;">KNOWN ENTITIES</h2>
                <div class="lore-entry">
                    <strong style="color:var(--fuel)">CARBON DEBRIS</strong><br>
                    Red rectangular fragments. Remains of burnt-out stars. Essential fuel source.
                </div>
                <div class="lore-entry">
                    <strong style="color:var(--scrap)">SCRAP METAL</strong><br>
                    Blue rectangular fragments. Ship wreckage. Used to upgrade Lens, Motor, and Focus.
                </div>
                <div class="lore-entry">
                    <strong style="color:#666">THE FOG</strong><br>
                    Semi-sentient particulate matter. It creates pressure on the light source. It flows like a liquid.
                </div>
            </div>
        </div>
    </div>

    <div id="death-screen">
        <div class="death-title">CRITICAL FAILURE</div>
        <p style="font-size:1.5rem; letter-spacing:3px; margin-top:20px;">LIGHT EXTINGUISHED</p>
        <p style="color:#888; margin-bottom:40px;">SURVIVAL TIME: <span id="score-time" style="color:#fff;">0</span> SECONDS</p>
        <button class="menu-btn" style="border-color:var(--fuel); color:var(--fuel);" onclick="location.reload()">INITIATE REBOOT</button>
    </div>

    <canvas id="world-canvas"></canvas>
    <canvas id="fog-canvas"></canvas>
    <div id="reticle"><div class="reticle-dot"></div></div>

    <div class="ui-layer" id="game-ui" style="display:none;">
        
        <div class="header-bar">
            <div>
                <h2 style="margin:0; font-size:1.5rem; letter-spacing:2px;">UNIT 734 // CORE</h2>
                <div class="resources">
                    <span class="c-fuel">FUEL: <b id="val-fuel">100</b></span>
                    <span class="c-scrap">SCRAP: <b id="val-scrap">0</b></span>
                </div>
            </div>
            <div style="display:flex; gap:15px; align-items:center;">
                <div id="time-display" style="color:#666;">T+ 0s</div>
                <button class="cog-btn" onclick="UI.openSettings()">âš™</button>
            </div>
        </div>

        <div class="log-container" id="log"></div>

        <div class="fuel-container">
            <div style="font-size:0.8rem; letter-spacing:3px; margin-bottom:8px; color:var(--fuel);">FUEL INTEGRITY</div>
            <div class="fuel-bar-bg"><div class="fuel-fill" id="bar-fuel"></div></div>
        </div>

        <button id="manual-open-btn" onclick="document.getElementById('manual-modal').style.display='flex'">ðŸ“–</button>

        <div class="upgrades">
            <button class="upgrade-btn" id="btn-lens" onclick="Game.buy('lens')">
                <span class="u-lvl" id="lvl-lens">1</span>
                <div style="font-weight:bold;">POLISHED LENS</div>
                <div style="font-size:0.75rem; color:var(--scrap);">COST: <span id="cost-lens">5</span></div>
                <div style="font-size:0.6rem; color:#666;">+BEAM RADIUS</div>
            </button>
            <button class="upgrade-btn" id="btn-gear" onclick="Game.buy('gear')">
                <span class="u-lvl" id="lvl-gear">1</span>
                <div style="font-weight:bold;">GEAR GREASE</div>
                <div style="font-size:0.75rem; color:var(--scrap);">COST: <span id="cost-gear">5</span></div>
                <div style="font-size:0.6rem; color:#666;">+ROTATION SPEED</div>
            </button>
            <button class="upgrade-btn" id="btn-focus" onclick="Game.buy('focus')">
                <span class="u-lvl" id="lvl-focus">1</span>
                <div style="font-weight:bold;">ARC FOCUS</div>
                <div style="font-size:0.75rem; color:var(--scrap);">COST: <span id="cost-focus">10</span></div>
                <div style="font-size:0.6rem; color:#666;">+BURN POWER</div>
            </button>
        </div>

    </div>

    <script>
        /**
         * PROJECT: VOID-KEEPER v1.3 (STABLE)
         * Restored Particles, Audio, Log, and Added Settings/Menus
         */

        const CONFIG = {
            fuelDecay: 2.0, 
            baseFogCreep: 0.04, 
            starCount: 200,
            debrisSpawnRate: 0.015 
        };

        const LoreData = [
            { time: 0, title: "BOOT SEQUENCE", text: "Unit 734 Online. Previous Keeper status: TERMINATED. Light levels critical." },
            { time: 30, title: "THE VANTABLACK", text: "Sensors indicate the darkness is not empty. It moves against the current." },
            { time: 60, title: "SIGNAL LOST", text: "Received distress signal from Sector 9. Abruptly silenced." },
            { time: 120, title: "THE HUNGER", text: "The fog consumes matter to grow density. We must burn it back." },
            { time: 300, title: "ANCIENT ECHO", text: "Detected structure in deep field. Analysis: Pre-Collapse Civilization." }
        ];

        const AudioSys = {
            ctx: null,
            masterNode: null,
            sfxNode: null,
            humOsc: null,
            focusOsc: null, // Separate osc for focus sound
            
            init() {
                if(!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                    this.masterNode = this.ctx.createGain();
                    this.sfxNode = this.ctx.createGain();
                    
                    this.masterNode.connect(this.ctx.destination);
                    this.sfxNode.connect(this.masterNode);
                    this.masterNode.gain.value = 0.5; // Default 50%
                    this.sfxNode.gain.value = 0.7; // Default 70%
                    
                    // Atmosphere Drone (Low Pass Filter)
                    this.humOsc = this.ctx.createOscillator();
                    this.humOsc.type = 'sawtooth';
                    this.humOsc.frequency.value = 50;
                    const humGain = this.ctx.createGain();
                    humGain.gain.value = 0.05;
                    const filter = this.ctx.createBiquadFilter();
                    filter.type = 'lowpass';
                    filter.frequency.value = 120;
                    
                    this.humOsc.connect(filter);
                    filter.connect(humGain);
                    humGain.connect(this.masterNode);
                    this.humOsc.start();
                }
                if(this.ctx.state === 'suspended') this.ctx.resume();
            },
            
            setMaster(val) { if(this.masterNode) this.masterNode.gain.value = val/100; },
            setSFX(val) { if(this.sfxNode) this.sfxNode.gain.value = val/100; },
            
            playCollect() {
                if(!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const g = this.ctx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1200, this.ctx.currentTime+0.1);
                g.gain.setValueAtTime(0.1, this.ctx.currentTime);
                g.gain.linearRampToValueAtTime(0, this.ctx.currentTime+0.2);
                osc.connect(g); g.connect(this.sfxNode);
                osc.start(); osc.stop(this.ctx.currentTime+0.2);
            },
            
            playFocus(active) {
                if(!this.ctx) return;
                if(active && !this.focusOsc) {
                    this.focusOsc = this.ctx.createOscillator();
                    this.focusGain = this.ctx.createGain();
                    this.focusOsc.type = 'triangle';
                    this.focusOsc.frequency.value = 200;
                    this.focusGain.gain.value = 0.05;
                    this.focusOsc.connect(this.focusGain);
                    this.focusGain.connect(this.sfxNode);
                    this.focusOsc.start();
                    this.focusOsc.frequency.linearRampToValueAtTime(400, this.ctx.currentTime + 0.5); // Charge up sound
                } else if(!active && this.focusOsc) {
                    this.focusOsc.stop();
                    this.focusOsc = null;
                }
            }
        };

        const Game = {
            wCv: document.getElementById('world-canvas'),
            fCv: document.getElementById('fog-canvas'),
            wCtx: null, fCtx: null,
            
            width: 0, height: 0, cx: 0, cy: 0,
            
            state: {
                playing: false,
                gameOver: false,
                paused: false,
                fuel: 100, maxFuel: 100,
                scrap: 0,
                startTime: 0,
                aliveTime: 0
            },

            settings: {
                quality: 'high',
                scale: 1.0,
                fpsInterval: 1000/60
            },

            beam: {
                angle: 0,
                rpm: 10,
                radius: 250,
                width: 0.5,
                baseWidth: 0.5,
                isHeld: false,
                targetAngle: 0
            },

            debris: [],
            stars: [],
            particles: [],
            mouse: {x:0, y:0},
            lastTime: 0,

            upgrades: { lens:1, gear:1, focus:1 },

            boot() {
                document.getElementById('main-menu').style.display = 'none';
                document.getElementById('game-ui').style.display = 'flex';
                
                this.wCtx = this.wCv.getContext('2d');
                this.fCtx = this.fCv.getContext('2d');
                
                this.resize();
                window.addEventListener('resize', () => this.resize());
                
                // Input Listeners
                window.addEventListener('mousedown', () => this.setHold(true));
                window.addEventListener('mouseup', () => this.setHold(false));
                window.addEventListener('touchstart', (e) => { this.setHold(true); this.updateMouse(e.touches[0]); }, {passive:false});
                window.addEventListener('touchend', () => this.setHold(false));
                window.addEventListener('mousemove', (e) => this.updateMouse(e));
                window.addEventListener('touchmove', (e) => { e.preventDefault(); this.updateMouse(e.touches[0]); }, {passive:false});

                // Click Debris Logic
                this.wCv.addEventListener('mousedown', (e) => this.checkClick(e.clientX, e.clientY));
                this.wCv.addEventListener('touchstart', (e) => this.checkClick(e.touches[0].clientX, e.touches[0].clientY), {passive:false});

                // Init World
                for(let i=0; i<150; i++) {
                    this.stars.push({ x: Math.random()*this.width, y: Math.random()*this.height, s: Math.random()*2, a: Math.random() });
                }

                this.state.playing = true;
                this.state.startTime = Date.now();
                this.log("SYSTEM INITIALIZED.");
                this.log("FOG DENSITY: 98%.");
                this.updateLore(); // Init Lore list
                AudioSys.init();
                
                requestAnimationFrame((t) => this.loop(t));
            },

            resize() {
                this.width = window.innerWidth;
                this.height = window.innerHeight;
                this.cx = this.width/2; this.cy = this.height/2;
                
                this.wCv.width = this.width * this.settings.scale;
                this.wCv.height = this.height * this.settings.scale;
                this.fCv.width = this.width * this.settings.scale;
                this.fCv.height = this.height * this.settings.scale;
                
                this.wCv.style.width = this.width + 'px';
                this.wCv.style.height = this.height + 'px';
                this.fCv.style.width = this.width + 'px';
                this.fCv.style.height = this.height + 'px';
                
                this.wCtx.scale(this.settings.scale, this.settings.scale);
                this.fCtx.scale(this.settings.scale, this.settings.scale);
            },

            log(msg) {
                const con = document.getElementById('log');
                const div = document.createElement('div');
                div.className = 'log-entry';
                const time = new Date();
                const ts = `${time.getHours()}:${time.getMinutes() < 10 ? '0'+time.getMinutes() : time.getMinutes()}:${time.getSeconds() < 10 ? '0'+time.getSeconds() : time.getSeconds()}`;
                div.innerHTML = `<span class="log-time">[${ts}]</span> ${msg}`;
                con.prepend(div);
                if(con.children.length > 8) con.lastChild.remove();
            },

            updateLore() {
                const list = document.getElementById('lore-list');
                list.innerHTML = '';
                LoreData.forEach(l => {
                    const div = document.createElement('div');
                    div.className = 'lore-entry';
                    if(this.state.aliveTime >= l.time) {
                        div.innerHTML = `<strong style="color:var(--term)">${l.title}</strong><br>${l.text}`;
                    } else {
                        div.innerHTML = `<span class="lore-locked">ENCRYPTED - REQ: ${l.time}s SURVIVAL</span>`;
                    }
                    list.appendChild(div);
                });
            },

            setHold(held) {
                if(this.state.paused || !this.state.playing) return;
                this.beam.isHeld = held;
                AudioSys.playFocus(held);
                const ret = document.getElementById('reticle');
                ret.style.display = held ? 'block' : 'none';
                
                if(held) {
                    this.beam.width = 0.15; // Narrow Focus
                } else {
                    this.beam.width = this.beam.baseWidth;
                }
            },

            updateMouse(e) {
                this.mouse.x = e.clientX;
                this.mouse.y = e.clientY;
                if(this.beam.isHeld) {
                    const ret = document.getElementById('reticle');
                    ret.style.left = e.clientX + 'px';
                    ret.style.top = e.clientY + 'px';
                }
            },

            checkClick(x, y) {
                if(this.state.paused || this.state.gameOver) return;
                
                for(let i=this.debris.length-1; i>=0; i--) {
                    let d = this.debris[i];
                    // IMPORTANT: Only clickable if revealed
                    if(!d.revealed) continue;
                    
                    let dist = Math.sqrt((x-d.x)**2 + (y-d.y)**2);
                    // Debris hit radius
                    if(dist < 40) {
                        // Harvest logic
                        let gain = (d.type==='fuel'?15:0);
                        this.state.fuel = Math.min(this.state.maxFuel, this.state.fuel + gain);
                        if(d.type==='scrap') this.state.scrap += 5;
                        
                        AudioSys.playCollect();
                        this.createParticles(d.x, d.y, d.color);
                        this.log(`HARVESTED: ${d.type.toUpperCase()}`);
                        
                        this.debris.splice(i, 1);
                        this.updateUI();
                        return;
                    }
                }
            },

            createParticles(x, y, color) {
                for(let i=0; i<15; i++) {
                    this.particles.push({
                        x: x, y: y,
                        vx: (Math.random()-0.5)*8, vy: (Math.random()-0.5)*8,
                        life: 1.0, color: color
                    });
                }
            },

            buy(type) {
                let cost = Math.floor(5 * Math.pow(1.5, this.upgrades[type]));
                if(type === 'focus') cost *= 2;
                
                if(this.state.scrap >= cost) {
                    this.state.scrap -= cost;
                    this.upgrades[type]++;
                    if(type === 'lens') { this.beam.radius += 40; this.log("OPTICS UPGRADED."); }
                    if(type === 'gear') { this.beam.rpm += 5; this.log("MOTORS OVERCLOCKED."); }
                    if(type === 'focus') { this.log("FOCUS ARRAY ALIGNED."); }
                    this.updateUI();
                }
            },

            hardWipe() {
                if(confirm("FACTORY RESET: THIS WILL DELETE ALL DATA. PROCEED?")) {
                    localStorage.clear();
                    location.reload();
                }
            },

            setQuality(val) { this.settings.quality = val; },
            setResolution(val) { this.settings.scale = parseFloat(val); this.resize(); },
            setFPS(val) { 
                let v = parseInt(val);
                this.settings.fpsInterval = (v === 0) ? 0 : 1000/v;
            },

            triggerDeath() {
                this.state.gameOver = true;
                document.getElementById('death-screen').style.display = 'flex';
                document.getElementById('score-time').innerText = Math.floor(this.state.aliveTime);
            },

            loop(t) {
                requestAnimationFrame((timestamp) => this.loop(timestamp));
                
                // FPS Limiter
                let elapsed = t - this.lastTime;
                if(this.settings.fpsInterval > 0 && elapsed < this.settings.fpsInterval) return;
                this.lastTime = t - (elapsed % this.settings.fpsInterval);

                if(!this.state.playing || this.state.paused || this.state.gameOver) return;

                // LOGIC
                this.state.aliveTime = (Date.now() - this.state.startTime) / 1000;
                this.state.fuel -= 0.05; // Fuel Decay
                if(this.state.fuel <= 0) { this.triggerDeath(); return; }

                if(this.beam.isHeld) {
                    // Manual Aim
                    let dx = this.mouse.x - this.cx;
                    let dy = this.mouse.y - this.cy;
                    let target = Math.atan2(dy, dx);
                    
                    // Smooth turn
                    let diff = target - this.beam.angle;
                    while(diff < -Math.PI) diff += Math.PI*2;
                    while(diff > Math.PI) diff -= Math.PI*2;
                    this.beam.angle += diff * 0.2;
                } else {
                    // Auto Spin
                    this.beam.angle += (this.beam.rpm * Math.PI * 2) / 3600;
                }

                // Spawn Debris
                if(Math.random() < 0.02) {
                    let a = Math.random() * Math.PI * 2;
                    let d = 100 + Math.random() * (this.width/2);
                    this.debris.push({
                        x: this.cx + Math.cos(a)*d,
                        y: this.cy + Math.sin(a)*d,
                        type: Math.random()>0.4?'fuel':'scrap',
                        revealed: false,
                        color: Math.random()>0.4?'#ff3333':'#00aaff'
                    });
                }

                // Update Particles
                for(let i=this.particles.length-1; i>=0; i--) {
                    let p = this.particles[i];
                    p.x += p.vx; p.y += p.vy; p.life -= 0.05;
                    if(p.life <= 0) this.particles.splice(i, 1);
                }

                // RENDER
                // 1. World
                this.wCtx.fillStyle = '#020202';
                this.wCtx.fillRect(0,0,this.width, this.height);
                
                // Stars
                this.wCtx.fillStyle = '#fff';
                this.stars.forEach(s => {
                    this.wCtx.globalAlpha = Math.random() * s.a;
                    this.wCtx.fillRect(s.x, s.y, s.s, s.s);
                });
                this.wCtx.globalAlpha = 1;

                // Debris
                this.debris.forEach(d => {
                    this.wCtx.save();
                    this.wCtx.translate(d.x, d.y);
                    this.wCtx.fillStyle = (d.type==='fuel') ? 'var(--fuel)' : 'var(--scrap)';
                    
                    if(d.revealed) {
                        // Draw Target Brackets
                        this.wCtx.strokeStyle = d.type==='fuel' ? 'var(--fuel)' : 'var(--scrap)';
                        this.wCtx.lineWidth = 2;
                        this.wCtx.strokeRect(-10, -10, 20, 20);
                        this.wCtx.font = '10px Share Tech Mono';
                        this.wCtx.fillStyle = '#fff';
                        this.wCtx.fillText(d.type.toUpperCase(), -10, -15);
                        
                        // Solid body when revealed
                        this.wCtx.fillStyle = d.color;
                        this.wCtx.fillRect(-4,-4,8,8);
                    } else {
                        // Just a faint glint in fog
                        if(Math.random()>0.95) {
                            this.wCtx.fillStyle = '#fff';
                            this.wCtx.fillRect(0,0,2,2);
                        }
                    }
                    this.wCtx.restore();
                });

                // Particles
                this.particles.forEach(p => {
                    this.wCtx.fillStyle = p.color;
                    this.wCtx.globalAlpha = p.life;
                    this.wCtx.fillRect(p.x, p.y, 3, 3);
                });
                this.wCtx.globalAlpha = 1;

                // Center Beacon
                this.wCtx.fillStyle = '#000';
                this.wCtx.beginPath(); this.wCtx.arc(this.cx, this.cy, 15, 0, Math.PI*2); this.wCtx.fill();
                this.wCtx.strokeStyle = 'var(--term)';
                this.wCtx.lineWidth = 2;
                this.wCtx.stroke();

                // 2. Fog
                let creepSpeed = CONFIG.baseFogCreep;
                if(this.state.fuel < 20) creepSpeed = 0.08;
                
                this.fCtx.globalCompositeOperation = 'source-over';
                this.fCtx.fillStyle = this.settings.quality === 'high' ? `rgba(5,5,5,${creepSpeed})` : 'rgba(0,0,0,0.2)'; 
                this.fCtx.fillRect(0,0,this.width, this.height);

                // Cut Beam
                this.fCtx.globalCompositeOperation = 'destination-out';
                this.fCtx.beginPath();
                this.fCtx.moveTo(this.cx, this.cy);
                let r = this.beam.radius;
                // Focus Mode burns further
                if(this.beam.isHeld) r *= 1.5;
                
                this.fCtx.arc(this.cx, this.cy, r, this.beam.angle - this.beam.width/2, this.beam.angle + this.beam.width/2);
                this.fCtx.closePath();
                
                if(this.settings.quality === 'high') {
                    let g = this.fCtx.createRadialGradient(this.cx, this.cy, 20, this.cx, this.cy, r);
                    g.addColorStop(0, 'rgba(0,0,0,1)');
                    g.addColorStop(1, 'rgba(0,0,0,0)');
                    this.fCtx.fillStyle = g;
                    this.fCtx.fill();
                } else {
                    this.fCtx.fill();
                }

                // Safe Zone
                this.fCtx.beginPath(); this.fCtx.arc(this.cx, this.cy, 60, 0, Math.PI*2); this.fCtx.fill();

                // 3. Logic: Reveal Check
                this.debris.forEach(d => {
                    let dx = d.x - this.cx; let dy = d.y - this.cy;
                    let dist = Math.sqrt(dx*dx + dy*dy);
                    let angle = Math.atan2(dy, dx);
                    let diff = angle - this.beam.angle;
                    while(diff < -Math.PI) diff += Math.PI*2;
                    while(diff > Math.PI) diff -= Math.PI*2;
                    
                    let activeR = this.beam.isHeld ? r : this.beam.radius;
                    let activeW = this.beam.width/2 + 0.1;
                    
                    // Reveal if inside beam
                    if(dist < activeR && Math.abs(diff) < activeW) {
                        d.revealed = true;
                    } else {
                        d.revealed = false;
                    }
                });

                this.updateUI();
            },

            updateUI() {
                document.getElementById('val-fuel').innerText = Math.floor(this.state.fuel);
                document.getElementById('val-scrap').innerText = this.state.scrap;
                document.getElementById('time-display').innerText = "T+ " + Math.floor(this.state.aliveTime) + "s";
                
                if(Math.floor(this.state.aliveTime) % 5 === 0) this.updateLore();

                const fuelPct = (this.state.fuel / this.state.maxFuel) * 100;
                document.getElementById('bar-fuel').style.width = fuelPct + "%";
                
                // Costs
                let cLens = Math.floor(5 * Math.pow(1.5, this.upgrades.lens));
                let cGear = Math.floor(5 * Math.pow(1.5, this.upgrades.gear));
                let cFocus = Math.floor(10 * Math.pow(1.5, this.upgrades.focus));
                
                document.getElementById('cost-lens').innerText = cLens;
                document.getElementById('cost-gear').innerText = cGear;
                document.getElementById('cost-focus').innerText = cFocus;
                
                document.getElementById('lvl-lens').innerText = this.upgrades.lens;
                document.getElementById('lvl-gear').innerText = this.upgrades.gear;
                document.getElementById('lvl-focus').innerText = this.upgrades.focus;

                document.getElementById('btn-lens').disabled = this.state.scrap < cLens;
                document.getElementById('btn-gear').disabled = this.state.scrap < cGear;
                document.getElementById('btn-focus').disabled = this.state.scrap < cFocus;
            }
        };

        const UI = {
            openSettings() { 
                Game.state.paused = true; 
                document.getElementById('settings-modal').style.display = 'flex'; 
            },
            closeSettings() { 
                Game.state.paused = false; 
                document.getElementById('settings-modal').style.display = 'none'; 
            },
            switchTab(idx, btn) {
                document.querySelectorAll('.man-page').forEach(p => p.classList.remove('active'));
                document.querySelectorAll('.man-tab').forEach(b => b.classList.remove('active'));
                document.getElementById(`page-${idx}`).classList.add('active');
                btn.classList.add('active');
            }
        };

    </script>
</body>
</html>